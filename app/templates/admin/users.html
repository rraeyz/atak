{% extends "base.html" %}

{% block title %}Kullanıcı Yönetimi - ATAK Kulübü{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="hero">
    <div class="hero-content">
        <h1>👥 Kullanıcı Yönetimi</h1>
        <p>Tüm kullanıcıları görüntüleyin ve yönetin</p>
    </div>
</section>

<!-- Admin Nav -->
<section style="padding: 2rem 0; background: rgba(30, 58, 138, 0.05);">
    <div class="container">
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center;">
            <a href="{{ url_for('admin.index') }}" class="btn btn-secondary">📊 Dashboard</a>
            <a href="{{ url_for('admin.users') }}" class="btn btn-primary">👥 Kullanıcılar</a>
            <a href="{{ url_for('admin.roles') }}" class="btn btn-secondary">🔐 Roller</a>
            <a href="{{ url_for('admin.events') }}" class="btn btn-secondary">🗓️ Etkinlikler</a>
            <a href="{{ url_for('admin.posts') }}" class="btn btn-secondary">📝 Yazılar</a>
            <a href="{{ url_for('admin.announcements') }}" class="btn btn-secondary">📢 Duyurular</a>
            <a href="{{ url_for('admin.messages') }}" class="btn btn-secondary">📧 Mesajlar</a>
            <a href="{{ url_for('admin.settings') }}" class="btn btn-secondary">⚙️ Ayarlar</a>
        </div>
    </div>
</section>

<!-- Users Table -->
<section style="padding: 4rem 0;">
    <div class="container">
        <!-- Gelişmiş Arama ve Filtreleme -->
        <div class="card" style="margin-bottom: 2rem;">
            <h3 class="card-title">🔍 Arama ve Filtreleme</h3>
            <form method="GET" action="{{ url_for('admin.users') }}">
                <div class="grid grid-2" style="gap: 1rem; margin-bottom: 1rem;">
                    <!-- Arama Alanı -->
                    <div class="form-group">
                        <label class="form-label">Arama</label>
                        <input type="text" name="search" class="form-control" 
                               value="{{ request.args.get('search', '') }}" 
                               placeholder="Kullanıcı adı, e-posta, isim veya soyisim...">
                    </div>
                    
                    <!-- Arama Türü -->
                    <div class="form-group">
                        <label class="form-label">Arama Alanı</label>
                        <select name="search_type" class="form-control">
                            <option value="all" {% if request.args.get('search_type', 'all') == 'all' %}selected{% endif %}>
                                Tüm Alanlarda
                            </option>
                            <option value="username" {% if request.args.get('search_type') == 'username' %}selected{% endif %}>
                                Kullanıcı Adı
                            </option>
                            <option value="email" {% if request.args.get('search_type') == 'email' %}selected{% endif %}>
                                E-posta
                            </option>
                            <option value="name" {% if request.args.get('search_type') == 'name' %}selected{% endif %}>
                                İsim Soyisim
                            </option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-2" style="gap: 1rem;">
                    <!-- Durum Filtresi -->
                    <div class="form-group">
                        <label class="form-label">Durum</label>
                        <select name="status" class="form-control">
                            <option value="" {% if not request.args.get('status') %}selected{% endif %}>
                                Tüm Kullanıcılar
                            </option>
                            <option value="pending" {% if request.args.get('status') == 'pending' %}selected{% endif %}>
                                ⏳ Onay Bekleyenler
                            </option>
                            <option value="approved" {% if request.args.get('status') == 'approved' %}selected{% endif %}>
                                ✓ Onaylananlar
                            </option>
                            <option value="banned" {% if request.args.get('status') == 'banned' %}selected{% endif %}>
                                🚫 Banlananlar
                            </option>
                        </select>
                    </div>
                    
                    <!-- Rol Filtresi -->
                    <div class="form-group">
                        <label class="form-label">Rol</label>
                        <select name="role" class="form-control">
                            <option value="" {% if not request.args.get('role') %}selected{% endif %}>
                                Tüm Roller
                            </option>
                            {% for role in all_roles %}
                            <option value="{{ role.id }}" {% if request.args.get('role')|int == role.id %}selected{% endif %}>
                                {{ role.display_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button type="submit" class="btn btn-primary">🔍 Ara</button>
                    <a href="{{ url_for('admin.users') }}" class="btn btn-secondary">🔄 Sıfırla</a>
                </div>
            </form>
        </div>
        
        <!-- Hızlı Filtreler -->
        <div style="margin-bottom: 2rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <a href="{{ url_for('admin.users') }}" class="btn btn-secondary btn-sm {% if not request.args.get('status') %}active{% endif %}">
                📋 Tümü
            </a>
            <a href="{{ url_for('admin.users', status='pending') }}" class="btn btn-secondary btn-sm {% if request.args.get('status') == 'pending' %}active{% endif %}">
                ⏳ Onay Bekleyenler
            </a>
            <a href="{{ url_for('admin.users', status='approved') }}" class="btn btn-secondary btn-sm {% if request.args.get('status') == 'approved' %}active{% endif %}">
                ✓ Onaylananlar
            </a>
            <a href="{{ url_for('admin.users', status='banned') }}" class="btn btn-secondary btn-sm {% if request.args.get('status') == 'banned' %}active{% endif %}">
                🚫 Banlananlar
            </a>
        </div>
        
        <div class="card">
            <h3 class="card-title">Kullanıcı Listesi</h3>
            
            {% if users %}
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Kullanıcı Adı</th>
                            <th>Ad Soyad</th>
                            <th>E-posta</th>
                            <th>Rol</th>
                            <th>Durum</th>
                            <th>Kayıt Tarihi</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>
                                <a href="{{ url_for('admin.user_detail', id=user.id) }}" 
                                   style="color: var(--cosmic-cyan); text-decoration: none;">
                                    {{ user.username }}
                                </a>
                            </td>
                            <td>{{ user.first_name }} {{ user.last_name }}</td>
                            <td>{{ user.email }}</td>
                            <td>
                                {% if user.role %}
                                    <span class="badge badge-primary">{{ user.role.name }}</span>
                                {% else %}
                                    <span class="badge badge-secondary">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if not user.is_active %}
                                    <span class="badge badge-danger">🚫 Banlandı</span>
                                {% elif user.is_approved %}
                                    <span class="badge badge-success">✓ Onaylı</span>
                                {% else %}
                                    <span class="badge badge-warning">⏳ Bekliyor</span>
                                {% endif %}
                            </td>
                            <td>{{ user.created_at.strftime('%d.%m.%Y') }}</td>
                            <td>
                                <div style="display: flex; gap: 0.25rem;">
                                    <a href="{{ url_for('admin.user_detail', id=user.id) }}" 
                                       class="btn btn-primary btn-sm">👁️</a>
                                    {% if not user.is_approved %}
                                        <form method="POST" action="{{ url_for('admin.approve_user', id=user.id) }}" 
                                              style="display: inline;">
                                            <button type="submit" class="btn btn-success btn-sm" 
                                                    title="Kullanıcıyı Onayla">✓</button>
                                        </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            {% if users.pages > 1 %}
            <div style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 2rem; flex-wrap: wrap; align-items: center;">
                {% if users.has_prev %}
                    <a href="{{ url_for('admin.users', page=users.prev_num, search=request.args.get('search', ''), search_type=request.args.get('search_type', 'all'), status=request.args.get('status', ''), role=request.args.get('role', '')) }}" 
                       class="btn btn-secondary btn-sm">← Önceki</a>
                {% endif %}
                
                <span style="padding: 0.5rem 1rem; color: var(--text-gray);">
                    Sayfa {{ users.page }} / {{ users.pages }} (Toplam: {{ users.total }} kullanıcı)
                </span>
                
                {% if users.has_next %}
                    <a href="{{ url_for('admin.users', page=users.next_num, search=request.args.get('search', ''), search_type=request.args.get('search_type', 'all'), status=request.args.get('status', ''), role=request.args.get('role', '')) }}" 
                       class="btn btn-secondary btn-sm">Sonraki →</a>
                {% endif %}
            </div>
            {% endif %}
            
            {% else %}
                <p style="color: var(--text-gray); text-align: center;">Kullanıcı bulunamadı.</p>
            {% endif %}
        </div>
    </div>
</section>
{% endblock %}
