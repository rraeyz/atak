{% extends "base.html" %}

{% block title %}Güvenlik Paneli - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Başlık ve İstatistikler Tek Satırda -->
    <div class="row align-items-center mb-3">
        <div class="col-md-3">
            <h4 class="mb-0">
                <i class="fas fa-shield-alt text-primary"></i> Güvenlik Paneli
            </h4>
            <small class="text-muted">
                <i class="fas fa-user"></i> {{ current_user.username }}
            </small>
        </div>
        
        <!-- Özet İstatistikler - Kompakt -->
        {% if events %}
        {% set total_events = events|length %}
        {% set total_registered = [] %}
        {% set total_checked_in = [] %}
        {% for event in events %}
            {% if total_registered.append(event.registrations.count()) %}{% endif %}
            {% if total_checked_in.append(event.check_ins|length) %}{% endif %}
        {% endfor %}
        {% set total_reg = total_registered|sum %}
        {% set total_check = total_checked_in|sum %}
        
        <div class="col-md-9">
            <div class="d-flex gap-2 justify-content-end flex-wrap">
                <div class="badge bg-primary p-2" style="min-width: 100px;">
                    <i class="fas fa-calendar-check"></i> {{ total_events }} Etkinlik
                </div>
                <div class="badge bg-info p-2" style="min-width: 100px;">
                    <i class="fas fa-users"></i> {{ total_reg }} Kayıtlı
                </div>
                <div class="badge bg-success p-2" style="min-width: 100px;">
                    <i class="fas fa-check-circle"></i> {{ total_check }} Giriş
                </div>
                <div class="badge bg-warning text-dark p-2" style="min-width: 100px;">
                    <i class="fas fa-hourglass-half"></i> {{ total_reg - total_check }} Bekleyen
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Etkinlik Listesi - Kompakt -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white py-2">
                    <h6 class="mb-0">
                        <i class="fas fa-calendar-check"></i> Aktif Etkinlikler
                    </h6>
                </div>
                <div class="card-body p-2">
                    {% if events %}
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 25%;">Etkinlik</th>
                                    <th style="width: 12%;">Tarih & Saat</th>
                                    <th style="width: 18%;">Lokasyon</th>
                                    <th style="width: 35%;" class="text-center">İstatistikler</th>
                                    <th style="width: 10%;" class="text-center">İşlem</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for event in events %}
                                <tr>
                                    <td>
                                        <strong class="text-primary">{{ event.title }}</strong>
                                        {% if event.event_date.date() == now.date() %}
                                        <span class="badge bg-success badge-sm">Bugün</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div style="font-size: 0.85rem;">
                                            <div><i class="fas fa-calendar text-muted"></i> {{ event.event_date.strftime('%d.%m.%Y') }}</div>
                                            <div><i class="fas fa-clock text-muted"></i> {{ event.event_date.strftime('%H:%M') }}</div>
                                        </div>
                                    </td>
                                    <td style="font-size: 0.9rem;">
                                        <i class="fas fa-map-marker-alt text-danger"></i> {{ event.location }}
                                    </td>
                                    <td>
                                        {% set total_registrations = event.registrations.count() %}
                                        {% set checked_in = event.check_ins|length %}
                                        {% set waiting = total_registrations - checked_in %}
                                        {% set percentage = ((checked_in / total_registrations) * 100)|int if total_registrations > 0 else 0 %}
                                        
                                        <div class="d-flex gap-1 justify-content-center align-items-center flex-wrap">
                                            <span class="badge bg-info" style="font-size: 0.75rem;" title="Toplam Kayıtlı">
                                                <i class="fas fa-users"></i> {{ total_registrations }}
                                            </span>
                                            <span class="badge bg-success" style="font-size: 0.75rem;" title="Giriş Yapan">
                                                <i class="fas fa-check"></i> {{ checked_in }}
                                            </span>
                                            <span class="badge bg-warning text-dark" style="font-size: 0.75rem;" title="Bekleyen">
                                                <i class="fas fa-clock"></i> {{ waiting }}
                                            </span>
                                            <span class="badge bg-secondary" style="font-size: 0.75rem;" title="Katılım Oranı">
                                                <i class="fas fa-percentage"></i> {{ percentage }}%
                                            </span>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <a href="{{ url_for('security.event_scanner', event_id=event.id) }}" 
                                           class="btn btn-primary btn-sm"
                                           style="font-size: 0.85rem; padding: 0.375rem 0.75rem; white-space: nowrap;"
                                           title="QR Kod Okut">
                                            <i class="fas fa-qrcode"></i> QR
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Şu anda aktif etkinlik bulunmamaktadır.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Bilgilendirme -->
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <i class="fas fa-qrcode fa-2x text-primary mb-2"></i>
                    <h6>QR Kod Okutma</h6>
                    <p class="small text-muted mb-0">
                        Katılımcıların QR kodlarını okutarak giriş yapabilirsiniz
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-success">
                <div class="card-body text-center">
                    <i class="fas fa-user-check fa-2x text-success mb-2"></i>
                    <h6>Otomatik Kayıt</h6>
                    <p class="small text-muted mb-0">
                        Kayıtlı kullanıcılar otomatik olarak giriş yapılır
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-info">
                <div class="card-body text-center">
                    <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                    <h6>Anlık İstatistik</h6>
                    <p class="small text-muted mb-0">
                        Giriş yapan katılımcıları anlık olarak takip edin
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
